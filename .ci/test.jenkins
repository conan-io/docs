#!groovyâ€‹

node('LinuxDocs') {
    String masterBranch = 'master'
    String branch = env.BRANCH_NAME
    boolean publishDocs = (branch == masterBranch)

    stage('Clone sources') {
        checkout scm
    }

    stage('Test build') {
        sh 'pip install -r requirements.txt'
        parallel html: {
            sh 'make html'
        },
        pdf: {
            sh 'make latex'
        },
        spelling: {
            sh 'make spelling'
        }
    }

    if (publishDocs) {
        String branches = sh(script: 'python3 .ci/scripts/get_branches.py', returnStdout: true).trim().readLines().join(',')
        echo "Will generate docs for ${branches}"
        build(job: 'Conan-Docs-Publish', propagate: true, wait: true, parameters: [
            [$class: 'StringParameterValue', name: 'branches', value: branches],
            [$class: 'BooleanParameterValue', name: 'publish', value: true]
        ])
    }
}
