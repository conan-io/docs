.. _reference_extensions_package_signing:

Package signing
---------------

.. warning::

  The package signing plugin is in **preview**.
  See :ref:`the Conan stability<stability>` section for more information.

This plugin is a Conan extension mechanism to sign and verify packages. For example with cosign sigstore, openssl...

This capability allows users to:

- Sign and verify packages stored in the local cache.
- Verify packages when installed.
- Upload signatures alongside packages to a remote server.


Configuration
=============

To enable package signing, the plugin should be placed in the cache at ``extensions/plugins/sign/sign.py``.


Implementation
==============

The plugin is a Python file that must define the following two functions:

For signing packages
++++++++++++++++++++

.. code-block:: python

    def sign(ref, artifacts_folder, signature_folder, **kwargs):
        """
        :param ref: The package reference being signed.
        :param artifacts_folder: Path to the folder containing the package artifacts (conaninfo.txt, conan_package.tgz, etc).
        :param signature_folder: Path to the folder where signatures should be written.
        :return: a list of signatures with their signing method and provider and the signing artifacts generated that are included in the package
        """
        # Logic to compute signatures of files in artifacts_folder
        # and write them to signature_folder.
        return [
          {
              "method": "openssl-dgst",  # The signing method indicates the tool used to sign the package so it can be verified later
              "provider": "my-organization",  # The signing provider indicates the organization that signed the package, so the correct public key is used for verification
              "sign_artifacts": {
                  "manifest": "pkgsign-manifest.json"  # This manifest file is generated by conan but should be added here
                  "signature": "pkgsign-manifest.json.sig"}}  # This is the signature file, typically signing the manifest file
        ]

The manifest file: ``pkgsign-manifest.json``
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Conan will **generate a JSON manifest file** called ``pkgsign-manifest.json`` in the signature folder right before calling the ``sign()`` method of the plugin.
This file is useful to check the integrity of the package and to **perform the sign over it by just signing this file (recommended)**.

Here is an example of the contents:

.. code-block:: json
   :caption: *<signature_folder>/pkgsign-manifest.json*

    {
      "files":[
        {
          "file":"conan_export.tgz",
          "sha256":"45c89ebf7d37d05f53472535db0d347019263bb5c6b990319108db6e66b85fe3"
        },
        {
          "file":"conan_sources.tgz",
          "sha256":"e757aa62bf6ac3cc5e36ecbd3c82c04d0faff46a61223189ee07e16489ef7c99"
        },
        {
          "file":"conanfile.py",
          "sha256":"12cc1f6477f6512158914c1041833db0b417d07d8f4f2538b07e5e4661d0139b"
        },
        {
          "file":"conanmanifest.txt",
          "sha256":"8d001ac33f5ea7e818d7c2e1aa2eb920d87472ada0b3abfeb0d8b2aaa1248653"
        }
      ]
    }

The signatures file: ``pkgsign-signatures.json``
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The function **should return a list of signatures** (see the example above) that will be **automatically saved by Conan into a JSON file** called ``pkgsign-signatures.json``.
This file is intended to list the signature metadata like the ``provider`` or ``method`` and the files that are part of the signature in the ``sign_artifacts`` field.

- ``method``: The signing method **indicates the tool used to sign the package so it can be verified later**. For example: gpg, cosign, x509, openssl...
- ``provider``: The **name of the organization** that signed the package. This is useful to later **verify the package with a matching public key** provided by the organization.
- ``sign_artifacts``: A list of the **files that are part of the signature**. This is useful to identify the files involved in the signature and use them in the verification step.

Additionally, **more than one signature is supported**, in case you need to sign with different formats or transition from one signature method to another.

Here is an example of the contents:

.. code-block:: json
   :caption: *<signature_folder>/pkgsign-signatures.json*


    {
      "signatures": [
        {
          "method": "openssl-dgst",
          "provider": "my-organization",
          "sign_artifacts": {
            "manifest": "pkgsign-manifest.json",
            "signature": "pkgsign-manifest.json.sig"
          }
        }
      ]
    }

For verifying packages
++++++++++++++++++++++

The following function should be implemented in the plugin:

.. code-block:: python

    def verify(ref, artifacts_folder, signature_folder, files, **kwargs):
        """
        :param ref: The package reference being verified.
        :param artifacts_folder: Path to the folder containing the package artifacts.
        :param signature_folder: Path to the folder containing the signatures.
        :param files: List of filenames to verify.
        """
        # Logic to verify that files in artifacts_folder match the
        # signatures in signature_folder.
        pass

Before calling the ``verify()`` function, **Conan will perform an integrity check** calculating the checksums of the package files
and checking against the manifest `pkgsign-signatures.json` file (if the file is present).

.. note::

    Note that the ``**kwargs`` argument in both functions is important to avoid future changes adding new arguments
    that would otherwise break the plugin, please make sure to add it to your methods.


Commands
========

This command will trigger the ``sign()`` method of the configured signing plugin.


.. code-block:: bash

    $ conan cache sign mypkg/1.0.0

And this one will trigger the ``verify()`` method of the plugin.

.. code-block:: bash

    $ conan cache verify mypkg/1.0.0


Plugin implementation examples
==============================

- `Signing packages with OpenSSL <https://github.com/conan-io/examples2/tree/main/examples/extensions/plugins/openssl_sign>`_
- Sigstore package singing plugin [TODO]
